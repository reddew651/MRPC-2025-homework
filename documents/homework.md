# 作业说明与评分提醒
完成题目 1 与题目 2 即可获得 30 分的文档作业基础分。
题目 3 是选做的附加题，具体得分可参考 README.md 。

## 统一报告要求
报告需导出为 PDF，并命名为 report.pdf 后放在 solutions 文件夹；如果选做了题目3，solutions 目录中必须包含 df_quaternion.csv ，以及 code/src 目录下需要包含 quadrotor_df 的 ROS 包。

## 题目 1: 坐标系转换
### 问题背景
在无人机（UAV）协同作业任务中，经常需要在无人机底部搭载机械臂与执行器（例如机械夹爪、吸盘、挂钩等），完成对特定目标的操作。为了精确控制执行器在世界坐标系中的位姿，必须将无人机本体的姿态变化与执行器相对于无人机本体的运动结合起来进行分析。比如，这个是我们实验室在空中机械臂的最新研究应用：[T-RO 2025] 空中机械臂。

本题假设无人机在飞行过程中跟踪某段轨迹，其姿态由四元数表示，见 tracking.csv ；同时，末端执行器相对于无人机本体（Body Frame）做圆锥形运动。

已知，末端执行器固连坐标系 $\mathcal{D}$ 相对于与机体系 $\mathcal{B}$ 的姿态变化为（这个无需自行推导）：
\[^{\mathcal{B}} R_{\mathcal{D}}=\left[\begin{array}{ccc} cos \omega t & -sin \omega t cos \alpha & sin \omega t sin \alpha \\ sin \omega t & cos \omega t cos \alpha & -cos \omega t sin \alpha \\ 0 & sin \alpha & cos \alpha\end{array}\right]\]
其中，$\omega=0.5 rad / s$ ，$\alpha=\pi / 12$ 。

### 提交方式
计算执行器在世界坐标系（World Frame）下的姿态（以四元数表示），绘制出四元数的变化曲线（为保证四元数时间序列的连续性，最终输出前请确保满足四元数归一化，且 $q_{w} ≥0$ ，若 $q_{w}<0$ ，请将四元数整体取反），然后把计算思路以及变化曲线放到报告里面（注意 tick 的大小和清晰度）。

## 题目 2: 开放题（规划 / 控制 / 动力学）
### 1. A* 轨迹规划的启发式与路径简化
阅读 code/src/trajectory_generator/src/Astar_searcher.cpp 中的 getHeu 与 AstarGetSucc 。现有的 tie_breaker 会轻微放大启发式以减少“走之”路径。请解释这种写法对开集拓展顺序与路径平滑性的影响；如果想让无人机更偏好平面飞行（减少不必要的高度变化），你会如何修改启发或边权？说明对可行性和最优性的影响。pathSimplify 采用递归的道格拉斯–普克（Douglas–Peucker）思路，按 path_resolution 过滤路径节点。结合仿真器的动力学（加速度与姿态约束），讨论过大或过小的 path_resolution 可能分别导致的跟踪误差与安全性问题。

### 2. SO(3) 位置控制器的力姿态生成
在 code/src/quadrotor_simulator/so3_control/src/SO3Control.cpp 中，calculateControl 将位置/速度误差、期望加速度前馈、重力补偿和与机体测得加速度相关的 ka 项叠加。说明各项在飞行中的作用，并解释为何在大误差或传感器噪声下需要对 ka 做截断或限幅。控制器会根据总力方向生成姿态，并将倾角限制在约 。若更重的机体需要保持相似的加速度跟踪，你会如何同时调整质量参数与 kx/kv 增益？讨论对推力大小、姿态角度以及系统稳定性的预期影响。

### 3. 动力学建模与约束
聚焦无人机动力学本身的建模与约束：结合仿真器（四旋翼刚体+重力+推力）说明质量、惯量与气动阻尼的建模简化如何影响控制分配；如果质量、阻尼估计有误，预期在轨迹跟踪中会出现什么可观测现象（如稳态偏差、过冲、振荡）？若想在模型中加入简单的气动阻力 $F_{d}=-k_{v} v$ ，你会在控制层（SO3Control ）还是规划层（轨迹限速）做出调整？说明各自的优缺点，并给出一个调整参数的思路。

### 提交方式
分别回答上述问题，并且按顺序将答案放到报告里面。

## 题目3: 无人机微分平坦性（Optional）
### 题目背景
在四旋翼无人机的控制中，微分平坦性是一个重要特性。它指出，系统状态和输入可以通过一组特定的平坦输出及其有限阶导数来代数表示。对于四旋翼，平坦输出通常选择为质心的位置 $(x, y, z)$ 和偏航角 $\psi$ 。

本题中，无人机的轨迹已在世界坐标系中给定，且规定偏航角 $\psi$ 始终与速度方向对齐。你的任务是利用微分平坦性（不考虑空气阻力），推导并计算出无人机在整个飞行过程中的姿态。

无人机轨迹为水平面内的双纽线（世界坐标系下）：
\[
\left\{
\begin{array}{l} 
x=\frac{10 cos t}{1+sin ^{2} t} \\ 
y=\frac{10 sin t cos t}{1+sin ^{2} t} \\ 
z=10 
\end{array}
\right.
\]
其中，$t \in[0,2 \pi)$ ，时间单位为秒。机体坐标系（Body Frame）定义：
x 轴：指向无人机前方（Front）
y 轴：指向无人机左侧（Left）
z 轴：指向无人机上方（Up）
这是一个 “前-左-上”（FLU）的坐标系。

### 任务要求
#### 1. 姿态推导过程
根据四旋翼的微分平坦性理论，由给定的位置轨迹 $[x(t), y(t), z(t)]$ 和偏航角 $\psi$ ，推导出无人机机体坐标系各轴在世界坐标系中的方向向量。
根据这些方向向量，构造世界系到机体系的旋转矩阵，并将其转换为四元数形式。

#### 2. 编程实现
在所提供的虚拟机 ROS 环境中，在 code/src 的工作空间下，创建一个新的 ROS Package，命名为 quadrotor_df ，在其中进行相关代码编写。
使用 C++ 及 Eigen 库 进行所有必要的向量和矩阵运算。
对时间 t 在区间 $[0,2 \pi)$ 内以合适的步长（如 0.02 秒）进行离散采样，计算每个时刻对应的姿态四元数。

#### 3. 输出文件
将计算结果保存为 df_quaternion.csv 文件。
根据 df_quaternion.csv 的结果绘制出四元数的变化曲线并且贴到报告中。
文件格式必须严格如下（时间保留两位小数，四元数保留7位小数，且要求归一化和 $q_{w} ≥0$ ）：
| 时间 | qx | qy | qz | qw |
| ---- | ---- | ---- | ---- | ---- |
| 0.00 | 0.0499792 | 0 | 0 | 0.9987503 |
| 0.02 | 0.0499167 | 0.0499167 | 0.0024979 | 0.9975021 |
| 0.04 | 0.0523491 | 0.0473595 | 0.0523491 | 0.9961306 |

### 提交方式
1. 把计算思路和最终的四元数变化图展示在报告中，力求简洁清晰为主。
2. quadrotor_df 这个 ROS 包放在 code/src 路径下一起提交。
3. 把最终得到的 df_quaternion.csv 放到 solutions 的文件夹中提交。